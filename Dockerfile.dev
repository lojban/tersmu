FROM haskell:9.8

# Install dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 \
    make \
    gcc \
    libc6-dev \
    libgmp-dev \
    git \
    && rm -rf /var/lib/apt/lists/*

# Install ghcid for hot reloading
RUN cabal update && cabal install ghcid
ENV PATH="/root/.cabal/bin:${PATH}"

WORKDIR /app

# Pre-fetch and build dependencies to cache them
# We copy only the cabal file first
COPY tersmu.cabal ./
RUN cabal build --only-dependencies exe:tersmu exe:tersmu-server

# The rest of the code will be mounted as a volume for hot reloading
# No need to COPY files here - they're mounted via docker-compose volumes

# Expose the server port
EXPOSE 8080

# Default command: run ghcid watching the server
# ghcid will automatically reload when files change in the mounted volume
CMD ["ghcid", "--command=cabal repl exe:tersmu-server", "--test=Main.main", "--allow-eval"]
